require no.ssb.fdb:44 as fdb 
create-dataset pop

//bruker befolkningen per 1.1.2024 
import fdb/BEFOLKNING_KOMMNR_FORMELL 2024-01-01 as bosted
generate fylke = substr(bosted,1,2)
generate kommnr = substr(bosted,1,4)

import fdb/BEFOLKNING_KJOENN as kjønn

//henter alder - bruker år -1 for å sikre at aldersfordelt befolkning samsvarere med tallene i statistikkbanken 
import fdb/BEFOLKNING_FOEDSELS_AAR_MND as faarmnd
generate alder = 2023 - int(faarmnd/100)

//lager aldersgrupper 5 årsgrupper
generate aldersgruppe = '0'
replace aldersgruppe = '0-4 år' if alder >= 0
replace aldersgruppe = '5-9 år' if alder >= 5
replace aldersgruppe = '10-14 år' if alder >= 10
replace aldersgruppe = '15-19 år' if alder >= 15
replace aldersgruppe = '20-24 år' if alder >= 20
replace aldersgruppe = '25-29 år' if alder >= 25
replace aldersgruppe = '30-34 år' if alder >= 30
replace aldersgruppe = '35-39 år' if alder >= 35
replace aldersgruppe = '40-44 år' if alder >= 40
replace aldersgruppe = '45-49 år' if alder >= 45
replace aldersgruppe = '50-54 år' if alder >= 50
replace aldersgruppe = '55-59 år' if alder >= 55
replace aldersgruppe = '60-64 år' if alder >= 60
replace aldersgruppe = '65-69 år' if alder >= 65
replace aldersgruppe = '70-74 år' if alder >= 70
replace aldersgruppe = '75-79 år' if alder >= 75
replace aldersgruppe = '80-84 år' if alder >= 80
replace aldersgruppe = '85-89 år' if alder >= 85
replace aldersgruppe = '90 eller eldre år' if alder >= 90
replace aldersgruppe = 'Ukjent alder' if sysmiss(faarmnd)

//begrenser populasjonen til personer mellom over 20 år
keep if alder >= 20
//keep if alder < 60

//legger til skatt i 2023
import fdb/SKATT_FASTSATT_SKATT 2023-12-31 as skatt
histogram skatt
summarize skatt
tabulate  aldersgruppe kjønn, summarize(skatt)
tabulate  aldersgruppe kjønn if fylke =='50' , summarize(skatt)

//setter missing til 0 
replace skatt = 0 if sysmiss(skatt)
histogram skatt
summarize skatt
tabulate aldersgruppe kjønn, summarize(skatt)
tabulate aldersgruppe kjønn if fylke =='50' , summarize(skatt)


//legger til overføringer i 2023
import fdb/INNTEKT_WOVERFOR 2023-12-31 as overføring
histogram overføring
summarize overføring
tabulate aldersgruppe kjønn, summarize(overføring)
tabulate aldersgruppe kjønn if fylke =='50' , summarize(overføring)


//to variabler på overføringer - test på den andre variablene for å se hva som er forskjellen mellom de to 
import fdb/INNTEKT_OVERFOR 2023-12-31 as overføring2
histogram overføring2
summarize overføring2
tabulate aldersgruppe kjønn if fylke =='50' , summarize(overføring2)


//velger å bruke INNTEKT_WOVERFOR videre 

//setter missing til 0 
replace overføring = 0 if sysmiss(overføring)
histogram overføring
summarize overføring
tabulate aldersgruppe kjønn, summarize(overføring)
tabulate aldersgruppe kjønn if fylke =='50' , summarize(overføring)

hexbin overføring skatt

//Lager nettooverføring
generate nettooverføring = skatt -overføring

histogram nettooverføring
summarize nettooverføring
tabulate aldersgruppe kjønn, summarize(nettooverføring)
tabulate aldersgruppe kjønn if fylke =='50' , summarize(nettooverføring)

tabulate aldersgruppe fylke, summarize(nettooverføring)

tabulate bosted, summarize(nettooverføring)

generate netto = 'Negativ'
replace netto = 'Positiv' if nettooverføring > 0

tabulate bosted netto, missing

//beholder kun trøndelag
keep if fylke =='50'

tabulate aldersgruppe netto, missing rowpct freq
tabulate aldersgruppe netto, summarize(overføring)
tabulate aldersgruppe netto, summarize(skatt)
tabulate aldersgruppe netto, summarize(nettooverføring)

//antaLL med og uten overføring 
generate mottar = 'Mottar'
replace mottar = 'Mottar ikke' if overføring ==0

tabulate aldersgruppe mottar, missing rowpct freq
tabulate aldersgruppe mottar, summarize(overføring)
tabulate aldersgruppe mottar, summarize(skatt)
tabulate aldersgruppe mottar, summarize(nettooverføring)


// Legger til Innvandringskategori
import fdb/BEFOLKNING_INVKAT as kat
generate Innvandringskategori = '3'
replace Innvandringskategori = '1' if kat == 'B'
replace Innvandringskategori = '2' if kat == 'C'
replace Innvandringskategori = 'Ukjent ' if sysmiss(kat)
define-labels Innvandringskategoritxt '1' 'Innvandrere' '2' 'Norskfødt med innvandrerforeldre' '3' 'Øvrig befolkning'
assign-labels Innvandringskategori Innvandringskategoritxt

tabulate aldersgruppe Innvandringskategori, summarize(skatt)
tabulate aldersgruppe Innvandringskategori, summarize(overføring)
tabulate aldersgruppe Innvandringskategori, summarize(nettooverføring)
tabulate aldersgruppe Innvandringskategori, summarize(nettooverføring) freq

//legger til Innvandringsgrunn
import fdb/BEFOLKNING_INNGRUNN1 as grunn

tabulate aldersgruppe grunn if Innvandringskategori == '1', summarize(nettooverføring)
tabulate aldersgruppe grunn if Innvandringskategori == '1', summarize(nettooverføring) freq

//legger til utdanningsnivå
import fdb/NUDB_BU 2023-08-01 as utd
generate utd1 = substr(utd,1,1)
//lager kategorier
generate utdniv = '9'
replace utdniv = '1' if utd1 == '1' | utd1 == '2'
replace utdniv = '2' if utd1 == '3' | utd1 == '4' | utd1 == '5'
replace utdniv = '3' if utd1 == '6'
replace utdniv = '4' if utd1 == '7' | utd1 == '8' 
define-labels utdnivtxt '1' 'Grunnskolenivå' '2'  'Videregående grunnopplæring' '3' 'Universitets og høgskolenivå kort' '4' 'Universitets og høgskolenivå lang' '9' 'Uoppgitt el ingen utdanning'
assign-labels utdniv utdnivtxt

tabulate aldersgruppe utdniv, summarize(skatt)
tabulate aldersgruppe utdniv, summarize(overføring)
tabulate aldersgruppe utdniv, summarize(nettooverføring)

tabulate Innvandringskategori utdniv, summarize(nettooverføring)

tabulate bosted netto, summarize(nettooverføring)

tabulate aldersgruppe netto, rowpct

tabulate alder utdniv, summarize(nettooverføring)
